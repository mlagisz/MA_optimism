---
title: "meta-analysis"
author: "ML"
date: "04/01/2020"
output: html_document
---

# MA of cognitive bias (optimism) in animal studies.

## STEP3 - MA modelling

(originally script: "Meta-Analaysis_merged_ML2.R")
This script runs main and additional models that are later used to create plots (STEP_04), tables (STEP_05) and results (STEP_06).


```{r setup, eval=TRUE, include=FALSE}
sessionInfo()
options(scipen=100)
pacman::p_load(tidyverse, magrittr, fulltext, rotl, ape, dplyr, tidyr, rotl, fulltext, metafor, car, robumeta, MuMIn, lme4, effects, MCMCglmm, multicomp)
source("./functions/functions.R") #functions specific to optimism project (data transformations) and calc.I2 function

#writeLines(capture.output(sessionInfo()), "./log_sessioninfo/sessionInfo.txt") #save session info into a text file
writeLines(capture.output(sessionInfo()), paste0("./log_sessioninfo/sessionInfo_STEP03_", format(Sys.time(), "%d-%b-%Y %H.%M"), ".txt")) #save session info into a text file with timestamp in the file name
```

```{r load data, eval=TRUE, include=FALSE} 
rm(list=ls()) # Clean up
dat <- read.csv("./data/MA_dataset_with_ES_subsets.csv") #for kntting
#dat <- read.csv("data/MA_dataset_with_ES_subsets.csv")
dim(dat) #459 76
str(dat) 
names(dat)

table(dat$ScalePoint) #we now have 5 scale points: MID   N  NN  NP   P

#### SUBSET with only ambiguous cue data points:
dat_amb <- dplyr::filter(dat, ScalePoint %in% c("MID","NN","NP"))
dim(dat_amb) #269

### SUBSETS from all data (proportion and latency) by picking only one ES from the curves/tests with >1 scale points (we use the prepared columns that already code these choices):
dat_max_ES <- dplyr::filter(dat, max_ES == 1) #subset by picking maximum ES from each curve (i.e. get the most positive=optimistic response available)
dim(dat_max_ES) #108

dat_max_absES <- dplyr::filter(dat, biggest_ES == 1) #subset by picking ES with the biggest absolute value from each curve (i.e. get the most positive or negatve response available)
dim(dat_max_absES) #108

dat_max_meanES <- dplyr::filter(dat, biggest_meandir == 1) #subset by picking ES from each curve which has the biggest absolute value in the direction of the mean value of all ES from the curve (i.e. biggest in the overall direction of the response)
dim(dat_max_meanES) #108

dat_MID_ES <- dplyr::filter(dat, ScalePoint == "MID") #subset by picking only middle (MID) ES from each curve
dim(dat_MID_ES) 


#### SUBSETS by MeasureType:
table(dat$MeasureType) # 201 "latency", 258 "proportion"

## proportion data (all scale points)
dat_prop <- dplyr::filter(dat, MeasureType == "proportion") #subset proportion data
dim(dat_prop)
dat_prop <- droplevels(dat_prop) 
str(dat_prop) # 16 (18?) species

##latency data (all scale points)
dat_lat <- dplyr::filter(dat, MeasureType == "latency") #subset latency data
dim(dat_lat) 
dat_lat <- droplevels(dat_lat) 
str(dat_lat) # 13 species


### SUBSETS from proportion data by picking only one ES from the curves/tests with >1 scale points [we use the columns that code already code these choices):
dat_prop_max_ES <- dplyr::filter(dat_prop, max_ES == 1) #subset by picking maximum ES from each curve (i.e. get the most positive=optimistic response available)
dim(dat_prop_max_ES) 

dat_prop_max_absES <- dplyr::filter(dat_prop, biggest_ES == 1) #subset by picking ES with the biggest absolute value from each curve (i.e. get the most positive or negatve response available)
dim(dat_prop_max_absES) 

dat_prop_max_meanES <- dplyr::filter(dat_prop, biggest_meandir == 1) #subset by picking ES from each curve which has the biggest absolute value in the direction of the mean value of all 3 ES from the curve (i.e. biggest in the overall direction of the response)
dim(dat_prop_max_meanES) 

dat_prop_MID_ES <- dplyr::filter(dat_prop, ScalePoint == "MID") #subset by picking only middle (MID) ES from each curve
dim(dat_prop_MID_ES) 



### SUBSETS from latency data by picking only one ES from the curves/tests with >1 Scale Points [we use the columns that code already code these choices):
dat_lat_max_ES <- dplyr::filter(dat_lat, max_ES == 1) #subset by picking maximum ES from each curve (i.e. get the most positive=optimistic response available)
dim(dat_lat_max_ES) #46

dat_lat_max_absES <- dplyr::filter(dat_lat, biggest_ES == 1) #subset by picking ES with the biggest absolute value from each curve (i.e. get the most positive or negatve response available)
dim(dat_lat_max_absES) 

dat_lat_max_meanES <- dplyr::filter(dat_lat, biggest_meandir == 1) #subset by picking ES from each curve which has the biggest absolute value in the direction of the mean value of all ES from the curve (i.e. biggest in the overall direction of the response)
dim(dat_lat_max_meanES) 

dat_lat_MID_ES <- dplyr::filter(dat_lat, ScalePoint == "MID") #subset by picking only middle (MID) ES from each curve
dim(dat_lat_MID_ES) 
```


```{r VCV matrices, eval=TRUE, include=FALSE} 
#### all data (proportion and latency)
## prepare VCV matrix - all data (proportion and latency)
VCV <- make_VCV_matrix(data = dat, V = "Vd", cluster = "GroupID", obs = "EffectID")
dim(VCV)

## data for ambiguous cues only:
VCV_dat_amb <- make_VCV_matrix(data = dat_amb, V = "Vd", cluster = "GroupID", obs = "EffectID")
dim(VCV_dat_amb)

## all data (proportion and latency) subsets without data triplicates:
## prepare VCV matrix - dat_max_absES all data (proportion and latency)
VCV_max_absES <- make_VCV_matrix(data = dat_max_absES, V = "Vd", cluster = "GroupID", obs = "EffectID")
dim(VCV_max_absES)

## prepare VCV matrix - dat_max_ES all data (proportion and latency)
VCV_max_ES <- make_VCV_matrix(data = dat_max_ES, V = "Vd", cluster = "GroupID", obs = "EffectID")
dim(VCV_max_ES)

## prepare VCV matrix - dat_max_meanES all data (proportion and latency)
VCV_max_meanES <- make_VCV_matrix(data = dat_max_meanES, V = "Vd", cluster = "GroupID", obs = "EffectID")
dim(VCV_max_meanES)

## prepare VCV matrix - dat_MID_ES all data (proportion and latency)
VCV_MID_ES <- make_VCV_matrix(data = dat_MID_ES, V = "Vd", cluster = "GroupID", obs = "EffectID")
dim(VCV_MID_ES)



#### proportion data 
## prepare VCV matrix - proportion data
VCV_prop <- make_VCV_matrix(data = dat_prop, V = "Vd", cluster = "GroupID", obs = "EffectID")
dim(VCV_prop)

## proportion data subsets without data triplicates:
## prepare VCV matrix - dat_max_absES proportion data
VCV_prop_max_absES <- make_VCV_matrix(data = dat_prop_max_absES, V = "Vd", cluster = "GroupID", obs = "EffectID")
dim(VCV_prop_max_absES)

## prepare VCV matrix - dat_max_ES proportion data
VCV_prop_max_ES <- make_VCV_matrix(data = dat_prop_max_ES, V = "Vd", cluster = "GroupID", obs = "EffectID")
dim(VCV_prop_max_ES)

## prepare VCV matrix - dat_max_meanES proportion data
VCV_prop_max_meanES <- make_VCV_matrix(data = dat_prop_max_meanES, V = "Vd", cluster = "GroupID", obs = "EffectID")
dim(VCV_prop_max_meanES)

## prepare VCV matrix - dat_MID_ES proportion data
VCV_prop_MID_ES <- make_VCV_matrix(data = dat_prop_MID_ES, V = "Vd", cluster = "GroupID", obs = "EffectID")
dim(VCV_prop_MID_ES)



#### latency data 
## prepare VCV matrix - latency data
VCV_lat <- make_VCV_matrix(data = dat_lat, V = "Vd", cluster = "GroupID", obs = "EffectID")
dim(VCV_lat)

## latency data subsets without data triplicates:
## prepare VCV matrix - dat_max_absES latency data
VCV_lat_max_absES <- make_VCV_matrix(data = dat_lat_max_absES, V = "Vd", cluster = "GroupID", obs = "EffectID")
dim(VCV_lat_max_absES)

## prepare VCV matrix - dat_max_ES latency data
VCV_lat_max_ES <- make_VCV_matrix(data = dat_lat_max_ES, V = "Vd", cluster = "GroupID", obs = "EffectID")
dim(VCV_lat_max_ES)

## prepare VCV matrix - dat_max_meanES latency data
VCV_lat_max_meanES <- make_VCV_matrix(data = dat_lat_max_meanES, V = "Vd", cluster = "GroupID", obs = "EffectID")
dim(VCV_lat_max_meanES)

## prepare VCV matrix - dat_MID_ES latency data
VCV_lat_MID_ES <- make_VCV_matrix(data = dat_lat_MID_ES, V = "Vd", cluster = "GroupID", obs = "EffectID")
dim(VCV_lat_MID_ES)
```


```{r phylo matrices, eval=TRUE, include=FALSE} 
## prepare species correlation matrix - all data (proportion and latency)
# Note: this matrix is also usable for  ES subsets from ScalePoint curve-based subsets
tree <- read.tree(file="./data/tree_all.tre")
is.binary.tree(tree) #TRUE
is.ultrametric(tree) #TRUE
# plot(tree, cex=0.8) #plot with branch lengths
CorMatrix_all <- vcv(tree, corr=TRUE)
#setdiff(colnames(CorMatrix_all), unique(dat$Species_Latin)) #all ok

## prepare species correlation matrix - proportion data
# Note: this matrix is also usable for  ES subsets from ScalePoint curve-based subsets
setdiff(unique(dat$Species_Latin), unique(dat_prop$Species_Latin) ) #missing species
tree_prop <- drop.tip(tree, setdiff(unique(dat$Species_Latin), unique(dat_prop$Species_Latin) )) # remove missing species from the tree
is.binary.tree(tree_prop) #TRUE
is.ultrametric(tree_prop) #TRUE
#plot(tree_prop)
CorMatrix_prop <- vcv(tree_prop, corr=TRUE)
#setdiff(colnames(CorMatrix_prop), unique(dat_prop$Species_Latin)) #all ok

## prepare species correlation matrix - latency data
# Note: this matrix is also usable for  ES subsets from ScalePoint curve-based subsets
setdiff(unique(dat$Species_Latin), unique(dat_lat$Species_Latin) ) #missing species
tree_lat <- drop.tip(tree, setdiff(unique(dat$Species_Latin), unique(dat_lat$Species_Latin) )) # remove missing species from the tree
is.binary.tree(tree_lat) #TRUE
is.ultrametric(tree_lat) #TRUE
#plot(tree_lat)
CorMatrix_lat <- vcv(tree_lat, corr=TRUE)
#setdiff(colnames(CorMatrix_lat), unique(dat_lat$Species_Latin)) #all ok
```



###############################################################################################################
#########################################       META-ANALYSIS       ########################################### 
###############################################################################################################

########################################################
#### All data points (full data set) - preliminary


## ** Random effect structure to be used**
#Choose random effect structure by conducting LRTs, and for that we need ML estimates
#Possible random effects: Article, Experiment, Species and phylogeny

```{r all data - chose random effects, eval=FALSE, include=FALSE}

meta1null <- rma.mv(yi = d, V = Vd, data=dat, method = 'ML') 
meta1study <- rma.mv(yi = d, V = Vd, random =~1|ArticleID, data=dat, method = 'ML') 
#adding ArticleID as random effects to correct for effect sizes from same paper
anova(meta1study, meta1null) #ArticleID is important

meta1exp <- rma.mv(yi = d, V = Vd, random =list(~1|ArticleID, ~1|ExperimentID), data=dat, method = 'ML') 
#adding ExperimentID as random effects to correct for effect sizes from same experiment
anova(meta1exp, meta1study) #ExperimentID is important

meta1sp = rma.mv(yi = d, V = Vd, random = ~1|Species_Latin, data=dat, method = 'ML')
anova(meta1sp, meta1null)
#Species is important by itself

meta1expsp <- rma.mv(yi = d, V = Vd, random =list(~1|ArticleID, ~1|ExperimentID, ~1|Species_Latin), data=dat, method = 'ML') 
anova(meta1expsp, meta1exp) #Species is not important with Article and Experiment IDs


meta1phy = rma.mv(yi = d, V = Vd, random = list(~1|ArticleID, ~1|ExperimentID, ~1|Species_Latin),
                             R = list(Species_Latin = CorMatrix_all), data=dat, method = 'ML')
anova(meta1phy, meta1null) #Phylogeny important relatively to null
anova(meta1phy, meta1exp) #Phylogeny not important relatively to model with Article and Experiment IDs

#models with VCV (variance-covariance matrices to account for non-independence)
meta1expVCV = rma.mv(yi = d, V = VCV, random = list(~1|ArticleID, ~1|ExperimentID), data=dat, method = 'ML')
#anova(meta1expVCV, meta1exp) #cant compare!

meta1phyVCV = rma.mv(yi = d, V = VCV, random = list(, ~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|GroupID),
                             R = list(Species_Latin = CorMatrix_all), data=dat, method = 'ML')
anova(meta1expVCV, meta1phyVCV) #Phylogeny not important relatively to model with Species, Article and Experiment IDs

AIC.rma(meta1null, meta1phy, meta1sp, meta1exp, meta1expsp, meta1expVCV, meta1phyVCV, correct = TRUE) #%>% arrange(AICc)
#meta1exp model has lowest AIC (Article and Experiment ID only), followed closely by meta1phy and meta1expsp (the smaller the AIC the better the fit)
```

########################################################
### All data points (full data set)

```{r MA all data, eval=TRUE, include=TRUE} 

######## random-effect model (no VCV matrix, no phylogeny)
MA_all_random <- rma.mv(yi=d, V=Vd, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID, ~1|Group_ID), 
                     data = dat, method="REML") 
summary(MA_all_random) 
calc.I2(dat$Vd, MA_all_random) 
save(MA_all_random, file = "Rdata/MA_all_random.Rdata")


######## random-effect model as above with VCV matrix (no phylogeny)
MA_all_random_VCV <- rma.mv(yi = d, V = VCV, 
                         random = list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID), 
                         data = dat, method = "REML")
summary(MA_all_random_VCV)
calc.I2(dat$Vd, MA_all_random_VCV)
save(MA_all_random_VCV, file = "Rdata/MA_all_random_VCV.Rdata")


######## random-effect model with VCV, phylogeny (Species_Latin) and species identity (ScientificName)
MA_all_random_VCV_phylo <- rma.mv(yi=d, V=VCV, 
                             random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ScientificName, ~1|ArticleID, ~1|ExperimentID, ~1|GroupID, ~1|EffectID),
                             R = list(Species_Latin = CorMatrix_all),
                             data = dat, method = "REML") 
summary(MA_all_random_VCV_phylo)   
calc.I2(dat$Vd, MA_all_random_VCV_phylo) #78.9% Htotal, 4.5% phylogeny, 0% speciesID - species identity contributed little to account for this heterogeneity (<0.01%); thus subsequent models will be run without species identity as random factor
save(MA_all_random_VCV_phylo, file = "Rdata/MA_all_random_VCV_phylo.Rdata")


######## random-effect model with VCV and phylogeny (Species_Latin), removed non-contibuting random effects
MA_all <- rma.mv(yi=d, V=VCV, 
                             random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                             R = list(Species_Latin = CorMatrix_all),
                             data = dat, method = "REML") 
summary(MA_all)    
calc.I2(dat$Vd, MA_all) #78.9% Htotal, 4.3% phylogeny - this is equivalent to "Shinichi" method *100% from function I2:
I2(MA_all, method = "Shinichi")
I2(MA_all, method = "Wolfgang") #this is default method for I2

save(MA_all, file = "Rdata/MA_all.Rdata")



######## random-effect model with VCV and no phylogeny and no species, removed non-contibuting random effects
MA_all_nophylo <- rma.mv(yi=d, V=VCV, 
                             random=list( ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                             data = dat, method = "REML") 
summary(MA_all_nophylo)    
calc.I2(dat$Vd, MA_all_nophylo) #78.8% Htotal, 
save(MA_all_nophylo, file = "Rdata/MA_all_nophylo.Rdata")


## Robust meta-analytic models:

#robumeta (without phylogeny and VCV)
MA_all_robu <- robu(formula = d ~ 1, var.eff.size = Vd, studynum = ExperimentID,  modelweights = "HIER", small = TRUE, data = dat)
print(MA_all_robu) #0.191  0.0732    0.31
#save(MA_all_robu,file="Rdata/MA_all_robu.Rdata")

#robust metafor
MA_all_robust <- robust(MA_all, cluster = dat$ExperimentID)
summary(MA_all_robust) #0.19  0.08  0.31
save(MA_all_robust,file = "Rdata/MA_all_robust.Rdata")
```


########################################################   
### Ambiguous cues ES data subset (dat_amb, k=269) - USE FOR THE MAIN TEXT    
Subset made from ES with ambiguous cues value from each curve (i.e. excluded responses to non-ambiguous cues)    

```{r MA MA_amb_nophylosubset, eval=TRUE, include=TRUE} 
######## random-effect model with VCV and  phylogeny, removed non-contibuting random effects
MA_amb <- rma.mv(yi=d, V=VCV_dat_amb, 
                             random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                             R = list(Species_Latin = CorMatrix_all),
                             data = dat_amb, method = "REML") 
summary(MA_amb)    
calc.I2(dat_amb$Vd, MA_amb) #79% Htotal, 6% phylo
save(MA_amb, file = "Rdata/MA_amb.Rdata")

######## random-effect model with VCV and no phylogeny and no species, removed non-contibuting random effects
MA_amb_nophylo <- rma.mv(yi=d, V=VCV_dat_amb, 
                             random=list(~1|ArticleID, ~1|ScalePoint, ~1|ExperimentID, ~1|EffectID),
                             data = dat_amb, method = "REML") 
summary(MA_amb_nophylo)    
calc.I2(dat_amb$Vd, MA_amb_nophylo) #78.8% Htotal, 
save(MA_amb_nophylo, file = "Rdata/MA_amb_nophylo.Rdata")
```


########################################################
### Max absolute ES data subset (dat_max_absES, k=106) - USE FOR THE MAIN TEXT
Subset made from ES with the biggest absolute value from each curve (i.e. get the most positive or negatve response available)


```{r MA dat_max_absES subset, eval=TRUE, include=TRUE} 

######## random-effect model (no VCV matrix, no phylogeny)
MA_maxabsES_random <- rma.mv(yi=d, V=Vd, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID), 
                     data = dat_max_absES, method="REML") 
summary(MA_maxabsES_random) 
calc.I2(dat_max_absES$Vd, MA_maxabsES_random) 
save(MA_maxabsES_random, file = "Rdata/MA_maxabsES_random.Rdata")


######## random-effect model as above with VCV matrix (no phylogeny)
MA_maxabsES_random_VCV <- rma.mv(yi = d, V = VCV_max_absES, 
                         random = list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID), 
                         data = dat_max_absES, method = "REML")
summary(MA_maxabsES_random_VCV)
calc.I2(dat_max_absES$Vd, MA_maxabsES_random_VCV)
save(MA_maxabsES_random_VCV, file = "Rdata/MA_maxabsES_random_VCV.Rdata")


######## random-effect model with VCV, phylogeny (Species_Latin) and species identity (ScientificName)
MA_maxabsES_random_VCV_phylo <- rma.mv(yi=d, V=VCV_max_absES, 
                             random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ScientificName, ~1|ArticleID, ~1|EffectID),
                             R = list(Species_Latin = CorMatrix_all),
                             data = dat_max_absES, method = "REML") 
summary(MA_maxabsES_random_VCV_phylo)   
calc.I2(dat_max_absES$Vd, MA_maxabsES_random_VCV_phylo) #90.1% Htotal, 0.% phylogeny, 0.2% speciesID
save(MA_maxabsES_random_VCV_phylo, file = "Rdata/MA_maxabsES_random_VCV_phylo.Rdata")


######## random-effect model with VCV and phylogeny (Species_Latin), removed non-contibuting random effects
MA_maxabsES <- rma.mv(yi=d, V=VCV_max_absES, 
                             random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                             R = list(Species_Latin = CorMatrix_all),
                             data = dat_max_absES, method = "REML") 
summary(MA_maxabsES)    
calc.I2(dat_max_absES$Vd, MA_maxabsES) #90%.55 Htotal, 2.9% phylogeny
save(MA_maxabsES, file = "Rdata/MA_maxabsES.Rdata")

######## random-effect model with VCV and no phylogeny and no species, removed non-contibuting random effects
MA_maxabsES_nophylo <- rma.mv(yi=d, V=VCV_max_ES, 
                             random=list(~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                             data = dat_max_absES, method = "REML") 
summary(MA_maxabsES_nophylo)    
calc.I2(dat_max_absES$Vd, MA_maxabsES_nophylo) #91.1% Htotal, 
save(MA_maxabsES_nophylo, file = "Rdata/MA_maxabsES_nophylo.Rdata")

## Robust meta-analytic models:

#robumeta (without phylogeny and VCV)
MA_maxabsES_robu <- robu(formula = d ~ 1, var.eff.size = Vd, studynum = ExperimentID,  modelweights = "HIER", smmaxabsES = TRUE, data = dat_max_absES)
print(MA_maxabsES_robu) #0.35  
#save(MA_maxabsES_robu,file="Rdata/MA_maxabsES_robu.Rdata")

#robust metafor
MA_maxabsES_robust <- robust(MA_maxabsES, cluster = dat_max_absES$ExperimentID)
summary(MA_maxabsES_robust) #0.38  0.8  0.7
save(MA_maxabsES_robust,file = "Rdata/MA_maxabsES_robust.Rdata")
```



########################################################
##### Max mean ES data subset (dat_max_meanES) - DO NOT USE (MENTION)
Subset of ES from each curve which has the biggest absolute value in the direction of the mean value of all ES from the curve (i.e. biggest in the overall direction of the overall response) 

```{r MA dat_max_meanES subset, eval=FALSE, include=FALSE} 

#NOTE: this data subset differs only by 13 data points from dat_max_absES data subset! (MA results are almost identical)
table(dat_max_meanES$d==dat_max_absES$d)

######## random-effect model (no VCV matrix, no phylogeny)
MA_maxmeanES_random <- rma.mv(yi=d, V=Vd, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID), 
                     data = dat_max_meanES, method="REML") 
summary(MA_maxmeanES_random) 
calc.I2(dat_max_meanES$Vd, MA_maxmeanES_random) 
save(MA_maxmeanES_random, file = "Rdata/MA_maxmeanES_random.Rdata")


######## random-effect model as above with VCV matrix (no phylogeny)
MA_maxmeanES_random_VCV <- rma.mv(yi = d, V = VCV_max_meanES, 
                         random = list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID), 
                         data = dat_max_meanES, method = "REML")
summary(MA_maxmeanES_random_VCV)
calc.I2(dat_max_meanES$Vd, MA_maxmeanES_random_VCV)
save(MA_maxmeanES_random_VCV, file = "Rdata/MA_maxmeanES_random_VCV.Rdata")


######## random-effect model with VCV, phylogeny (Species_Latin) and species identity (ScientificName)
MA_maxmeanES_random_VCV_phylo <- rma.mv(yi=d, V=VCV_max_meanES, 
                             random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ScientificName, ~1|ArticleID, ~1|EffectID),
                             R = list(Species_Latin = CorMatrix_all),
                             data = dat_max_meanES, method = "REML") 
summary(MA_maxmeanES_random_VCV_phylo)   
calc.I2(dat_max_meanES$Vd, MA_maxmeanES_random_VCV_phylo) #89% Htotal, 7% phylogeny, 0% speciesID
save(MA_maxmeanES_random_VCV_phylo, file = "Rdata/MA_maxmeanES_random_VCV_phylo.Rdata")


######## random-effect model with VCV and phylogeny (Species_Latin), removed non-contibuting random effects
MA_maxmeanES <- rma.mv(yi=d, V=VCV_max_meanES, 
                             random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                             R = list(Species_Latin = CorMatrix_all),
                             data = dat_max_meanES, method = "REML") 
summary(MA_maxmeanES)    
calc.I2(dat_max_meanES$Vd, MA_maxmeanES) #89% Htotal, 9% phylogeny
save(MA_maxmeanES, file = "Rdata/MA_maxmeanES.Rdata")


## Robust meta-analytic models:

#robumeta (without phylogeny and VCV)
MA_maxmeanES_robu <- robu(formula = d ~ 1, var.eff.size = Vd, studynum = ExperimentID,  modelweights = "HIER", smmaxmeanES = TRUE, data = dat_max_meanES)
print(MA_maxmeanES_robu)
#save(MA_maxmeanES_robu,file="Rdata/MA_maxmeanES_robu.Rdata")

#robust metafor
MA_maxmeanES_robust <- robust(MA_maxmeanES, cluster = dat_max_meanES$ExperimentID)
summary(MA_maxmeanES_robust) #0.60  0.29  0.92
save(MA_maxmeanES_robust,file = "Rdata/MA_maxmeanES_robust.Rdata")
```



########################################################
### Max MID ES data subset (dat_MID_ES) - DO NOT USE (MENTION)
Subset of ES from each curve which isin the midpoint (i.e. MID) 

```{r MA dat_MID_ES subset, eval=FALSE, include=FALSE} 

######## random-effect model (no VCV matrix, no phylogeny)
MA_MID_ES_random <- rma.mv(yi=d, V=Vd, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|GroupID, ~1|EffectID), 
                     data = dat_MID_ES, method="REML") 
summary(MA_MID_ES_random) 
calc.I2(dat_MID_ES$Vd, MA_MID_ES_random) 
save(MA_MID_ES_random, file = "Rdata/MA_MID_ES_random.Rdata")


######## random-effect model as above with VCV matrix (no phylogeny)
MA_MID_ES_random_VCV <- rma.mv(yi = d, V = VCV_MID_ES, 
                         random = list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID), 
                         data = dat_MID_ES, method = "REML")
summary(MA_MID_ES_random_VCV)
calc.I2(dat_MID_ES$Vd, MA_MID_ES_random_VCV)
save(MA_MID_ES_random_VCV, file = "Rdata/MA_MID_ES_random_VCV.Rdata")


######## random-effect model with VCV, phylogeny (Species_Latin) and species identity (ScientificName)
MA_MID_ES_random_VCV_phylo <- rma.mv(yi=d, V=VCV_MID_ES, 
                             random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ScientificName, ~1|ArticleID, ~1|EffectID),
                             R = list(Species_Latin = CorMatrix_all),
                             data = dat_MID_ES, method = "REML") 
summary(MA_MID_ES_random_VCV_phylo)   
calc.I2(dat_MID_ES$Vd, MA_MID_ES_random_VCV_phylo) #80% Htotal, 8% phylogeny, 0% speciesID
save(MA_MID_ES_random_VCV_phylo, file = "Rdata/MA_MID_ES_random_VCV_phylo.Rdata")


######## random-effect model with VCV and phylogeny (Species_Latin), removed non-contibuting random effects
MA_MID_ES <- rma.mv(yi=d, V=VCV_MID_ES, 
                             random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                             R = list(Species_Latin = CorMatrix_all),
                             data = dat_MID_ES, method = "REML") 
summary(MA_MID_ES )    
calc.I2(dat_MID_ES$Vd, MA_MID_ES ) #80% Htotal, 9% phylogeny
save(MA_MID_ES, file = "Rdata/MA_MID_ES.Rdata")


## Robust meta-analytic models:

#robumeta (without phylogeny and VCV)
MA_MID_ES_robu <- robu(formula = d ~ 1, var.eff.size = Vd, studynum = ExperimentID,  modelweights = "HIER", smB_ES  = TRUE, data = dat_MID_ES)
print(MA_MID_ES_robu)
#save(MA_MID_ES_robu,file="Rdata/MA_MID_ES_robu.Rdata")

#robust metafor
MA_MID_ES_robust <- robust(MA_MID_ES , cluster = dat_MID_ES$ExperimentID)
summary(MA_MID_ES_robust) #0.29  0.09  0.49
save(MA_MID_ES_robust,file = "Rdata/MA_MID_ES_robust.Rdata")
```


########################################################
### Max ES data subset (dat_max_ES) - DO NOT USE    
Subset of maximum ES from each curve (i.e. get the most positive=optimistic response available)    

```{r MA dat_max_ES subset, eval=FALSE, include=FALSE} 

######## random-effect model (no VCV matrix, no phylogeny)
MA_maxES_random <- rma.mv(yi=d, V=Vd, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID), 
                     data = dat_max_ES, method="REML") 
summary(MA_maxES_random) 
calc.I2(dat_max_ES$Vd, MA_maxES_random) 
save(MA_maxES_random, file = "Rdata/MA_maxES_random.Rdata")


######## random-effect model as above with VCV matrix (no phylogeny)
MA_maxES_random_VCV <- rma.mv(yi = d, V = VCV_max_ES, 
                         random = list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID), 
                         data = dat_max_ES, method = "REML") #not converging
summary(MA_maxES_random_VCV)
calc.I2(dat_max_ES$Vd, MA_maxES_random_VCV)
save(MA_maxES_random_VCV, file = "Rdata/MA_maxES_random_VCV.Rdata")


######## random-effect model with VCV, phylogeny (Species_Latin) and species identity (ScientificName)
MA_maxES_random_VCV_phylo <- rma.mv(yi=d, V=VCV_max_ES, 
                             random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ScientificName, ~1|ArticleID, ~1|EffectID),
                             R = list(Species_Latin = CorMatrix_all),
                             data = dat_max_ES, method = "REML") 
summary(MA_maxES_random_VCV_phylo)   
calc.I2(dat_max_ES$Vd, MA_maxES_random_VCV_phylo) #78% Htotal, 0% phylogeny, 0% speciesID
save(MA_maxES_random_VCV_phylo, file = "Rdata/MA_maxES_random_VCV_phylo.Rdata")


######## random-effect model with VCV and phylogeny (Species_Latin), removed non-contibuting random effects
MA_maxES <- rma.mv(yi=d, V=VCV_max_ES, 
                             random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                             R = list(Species_Latin = CorMatrix_all),
                             data = dat_max_ES, method = "REML")  #not converging
summary(MA_maxES)    
calc.I2(dat_max_ES$Vd, MA_maxES) #78% Htotal, 0% phylogeny
save(MA_maxES, file = "Rdata/MA_maxES.Rdata")

######## random-effect model with VCV and no phylogeny and no species, removed non-contibuting random effects
MA_maxES_nophylo <- rma.mv(yi=d, V=VCV_max_ES, 
                             random=list(~1|ArticleID, ~1|ScalePoint, ~1|ExperimentID, ~1|EffectID),
                             data = dat_max_ES, method = "REML") 
summary(MA_maxES_nophylo)    
calc.I2(dat_max_ES$Vd, MA_maxES_nophylo) #78.0% Htotal, 
save(MA_maxES_nophylo, file = "Rdata/MA_maxES_nophylo.Rdata")

## Robust meta-analytic models:

#robumeta (without phylogeny and VCV)
MA_maxES_robu <- robu(formula = d ~ 1, var.eff.size = Vd, studynum = ExperimentID,  modelweights = "HIER", smmaxES = TRUE, data = dat_max_ES)
print(MA_maxES_robu) #0.54  0.4    0.7
#save(MA_maxES_robu,file="Rdata/MA_maxES_robu.Rdata")

#robust metafor
MA_maxES_robust <- robust(MA_maxES, cluster = dat_max_ES$ExperimentID)
summary(MA_maxES_robust) #0.54  0.4  0.7
save(MA_maxES_robust,file = "Rdata/MA_maxES_robust.Rdata")
```



###############################################################################################################
#########################################     UNIVARIATE  META-REGRESSIONS on ALL DATA      
###############################################################################################################

#### SPECIES ####

### Species_Latin (Species model) on all data points  - USE IN MAIN TEXT
```{r MR all data - Species model, eval=TRUE, include=TRUE}
#with phylogeny
MR_all_species <- rma.mv(yi=d, V=VCV, 
                     mod = ~ScientificName -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_species) # no species with clear effect
save(MR_all_species, file = "Rdata/MR_all_species.Rdata")

#without phylogeny
MR_all_species_nophylo <- rma.mv(yi=d, V=VCV, 
                     mod = ~ScientificName -1, 
                     random=list(~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID), 
                     data = dat, method="REML") 
summary(MR_all_species_nophylo) # only rat with clear effect, when phylogeny not taken into account
save(MR_all_species_nophylo, file = "Rdata/MR_all_species_nophylo.Rdata")
```



########################################################
#### dat_max_absES - Species_Latin (Species model) - USE IN MAIN TEXT

```{r MR dat_max_absES data - Species model, eval=TRUE, include=TRUE}
#with phylogeny
MR_all_species_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~ScientificName -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_species_max_absES) # cow signif positive
save(MR_all_species_max_absES, file = "Rdata/MR_all_species_max_absES.Rdata")

#without phylogeny
MR_all_species_max_absES_nophylo <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~ScientificName -1, 
                     random=list(~1|ArticleID, ~1|ScalePoint, ~1|ExperimentID, ~1|EffectID), 
                     data = dat_max_absES, method="REML")
summary(MR_all_species_max_absES_nophylo) # rat and cow
save(MR_all_species_max_absES_nophylo, file = "Rdata/MR_all_species_max_absES_nophylo.Rdata")
```


########################################################
#### dat_max_meanES - Species_Latin (Species model) - DONT USE

```{r MR dat_max_meanES data - Species model, eval=FALSE, include=FALSE}
#with phylogeny
MR_maxmeanES_species <- rma.mv(yi=d, V=VCV_max_meanES, 
                     mod = ~ScientificName -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_meanES, method="REML") 
summary(MR_maxmeanES_species) 
save(MR_maxmeanES_species, file = "Rdata/MR_maxmeanES_species.Rdata")

#without phylogeny
MR_maxmeanES_species_nophylo <- rma.mv(yi=d, V=VCV_max_meanES, 
                     mod = ~ScientificName -1, 
                     random=list(~1|ArticleID, ~1|ScalePoint, ~1|ExperimentID, ~1|EffectID), 
                     data = dat_max_meanES, method="REML") 
summary(MR_maxmeanES_species_nophylo)
save(MR_maxmeanES_species_nophylo, file = "Rdata/MR_maxmeanES_species_nophylo.Rdata")
```

#### dat_max_ES - Species_Latin (Species model) - DONT USE

```{r MR dat_max_ES data - Species model, eval=FALSE, include=FALSE}
#with phylogeny
MR_maxES_species <- rma.mv(yi=d, V=VCV_max_ES, 
                     mod = ~ScientificName -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_ES, method="REML") 
summary(MR_maxES_species) # bee, cow - signif positive
save(MR_maxES_species, file = "Rdata/MR_maxES_species.Rdata")

#without phylogeny
MR_maxES_species_nophylo <- rma.mv(yi=d, V=VCV_max_ES, 
                     mod = ~ScientificName -1, 
                     random=list(~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID), 
                     data = dat_max_ES, method="REML") 
summary(MR_maxES_species_nophylo) # some species with clear effect, when phylogeny not taken into account
save(MR_maxES_species_nophylo, file = "Rdata/MR_maxES_species_nophylo.Rdata")
```





############################################################
##### MR - MeasureType #####

##### MeasureType on all data points - USE IN MAIN TEXT

```{r MR all data - MeasureType, eval=TRUE, include=TRUE}
#with phylogeny
MR_all_MeasureType <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$MeasureType, ref="latency"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_MeasureType) # ns diff proportion / latency
save(MR_all_MeasureType, file = "Rdata/MR_all_MeasureType.Rdata")

#intercepts model
MR_all_MeasureType1 <- rma.mv(yi=d, V=VCV, 
                     mod = ~MeasureType -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_MeasureType1) # signif intc proportion and latency
save(MR_all_MeasureType1, file = "Rdata/MR_all_MeasureType1.Rdata")
```


########################################################
#### dat_max_absES - Measure Type - USE IN MAIN TEXT

```{r MR dat_max_absES data - MeasureType model}
#with phylogeny
MR_all_MeasureType_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$MeasureType, ref="proportion"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_MeasureType_max_absES) # non-signif diff proportion / latency
save(MR_all_MeasureType_max_absES, file = "Rdata/MR_all_MeasureType_max_absES.Rdata")

#intercepts model
MR_all_MeasureType1_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~MeasureType -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_MeasureType1_max_absES) # signif intc proportion, not latency
save(MR_all_MeasureType1_max_absES, file = "Rdata/MR_all_MeasureType1_max_absES.Rdata")
```



################### OTHER UNIVARIATE META-REGRESSIONS
- Sex   
- Age   
- Source of Animals
- AffectManipCat   
- AffectManipTiming   
- ComparisonCategory   
- CueTypeCat   
- FoodDeprived   
- TaskType   
- Randomized_WithinBetween   
- Automated   
- Blind   
- ReinforcementCat
- AmbigReinforced
- ScalePoint


#Univariate models:

- Sex
```{r MR all data - Sex}
MR_all_sex1 <- rma.mv(yi=d, V=VCV, 
                     mod = ~Sex -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_sex1) # signif intc for males only
save(MR_all_sex1, file = "Rdata/MR_all_sex1.Rdata")

MR_all_sex <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$Sex, ref="female"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_sex) # ns intc for females, signif diff female-male
save(MR_all_sex, file = "Rdata/MR_all_sex.Rdata")

MR_all_sex2 <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$Sex, ref="male"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_sex2) # signif intc for males, signif diff female-male
save(MR_all_sex2, file = "Rdata/MR_all_sex2.Rdata")

#max_absES

MR_all_sex1_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~Sex -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_sex1_max_absES) # signif intc for males only
save(MR_all_sex1_max_absES, file = "Rdata/MR_all_sex1_max_absES.Rdata")

MR_all_sex_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$Sex, ref="female"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_sex_max_absES) # ns intc for females, signif diff female-male
save(MR_all_sex_max_absES, file = "Rdata/MR_all_sex_max_absES.Rdata")

MR_all_sex2_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$Sex, ref="male"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_sex2_max_absES) # signif intc for males, signif diff female-male
save(MR_all_sex2_max_absES, file = "Rdata/MR_all_sex2_max_absES.Rdata")
```


- Age
```{r MR all data - Age}
MR_all_age1 <- rma.mv(yi=d, V=VCV, 
                     mod = ~Age -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint,  ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_age1) # no signif intc adult/juvenile
save(MR_all_age1, file = "Rdata/MR_all_age1.Rdata")

MR_all_age <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$Age, ref="adult"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_age) # no signif diff adult-juvenile
save(MR_all_age, file = "Rdata/MR_all_age.Rdata")

#max_absES

MR_all_age1_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~Age -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint,  ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_age1_max_absES) # no signif intc adult/juvenile
save(MR_all_age1_max_absES, file = "Rdata/MR_all_age1_max_absES.Rdata")

MR_all_age_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$Age, ref="adult"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_age_max_absES) # no signif diff adult-juvenile
save(MR_all_age_max_absES, file = "Rdata/MR_all_age_max_absES.Rdata")
```

- Source (Captive_Wild.caught)
```{r MR all data - Captive_Wild.caught}
MR_all_source1 <- rma.mv(yi=d, V=VCV, 
                     mod = ~Captive_Wild.caught -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_source1) # no signif intc captive/wild-caught
save(MR_all_source1, file = "Rdata/MR_all_source1.Rdata")

MR_all_source <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$Captive_Wild.caught, ref="captive"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_source) # no signif diff captive/wild-caught
save(MR_all_source, file = "Rdata/MR_all_source.Rdata")

#max_absES

MR_all_source1_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~Captive_Wild.caught -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_source1_max_absES) # no signif intc captive/wild-caught
save(MR_all_source1_max_absES, file = "Rdata/MR_all_source1_max_absES.Rdata")

MR_all_source_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$Captive_Wild.caught, ref="captive"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint,  ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_source_max_absES) # no signif diff captive/wild-caught
save(MR_all_source_max_absES, file = "Rdata/MR_all_source_max_absES.Rdata")
```


- AffectManipCat
```{r MR all data - AffectManipCat}
MR_all_AffectManipCat1 <- rma.mv(yi=d, V=VCV, 
                     mod = ~AffectManipCat -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint,  ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_AffectManipCat1) # no signif intc enrichment/stress
save(MR_all_AffectManipCat1, file = "Rdata/MR_all_AffectManipCat1.Rdata")

MR_all_AffectManipCat <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$AffectManipCat, ref="enrichment"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_AffectManipCat) # no signif diff enrichment/stress
save(MR_all_AffectManipCat, file = "Rdata/MR_all_AffectManipCat.Rdata")

#max_absES

MR_all_AffectManipCat1_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~AffectManipCat -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint,  ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_AffectManipCat1_max_absES) # signif intc enrichment/stress
save(MR_all_AffectManipCat1_max_absES, file = "Rdata/MR_all_AffectManipCat1_max_absES.Rdata")

MR_all_AffectManipCat_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$AffectManipCat, ref="enrichment"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_AffectManipCat_max_absES) # no signif diff enrichment/stress
save(MR_all_AffectManipCat_max_absES, file = "Rdata/MR_all_AffectManipCat_max_absES.Rdata")
```


- AffectManipTiming
```{r MR all data - AffectManipTiming}
MR_all_AffectManipTiming1 <- rma.mv(yi=d, V=VCV, 
                     mod = ~AffectManipTiming -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint,  ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_AffectManipTiming1) # no signif intc before/during / long-term
save(MR_all_AffectManipTiming1, file = "Rdata/MR_all_AffectManipTiming1.Rdata")

MR_all_AffectManipTiming <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$AffectManipTiming, ref="before/during"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint,  ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_AffectManipTiming) # no signif diff  before/during / long-term
save(MR_all_AffectManipTiming, file = "Rdata/MR_all_AffectManipTiming.Rdata")

#max_absES

MR_all_AffectManipTiming1_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~AffectManipTiming -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_AffectManipTiming1_max_absES) # no signif intc before/during / long-term
save(MR_all_AffectManipTiming1_max_absES, file = "Rdata/MR_all_AffectManipTiming1_max_absES.Rdata")

MR_all_AffectManipTiming_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$AffectManipTiming, ref="before/during"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_AffectManipTiming_max_absES) # no signif diff  before/during / long-term
save(MR_all_AffectManipTiming_max_absES, file = "Rdata/MR_all_AffectManipTiming_max_absES.Rdata")
```


- ComparisonCategory
```{r MR all data - ComparisonCategory}
MR_all_ComparisonCategory1 <- rma.mv(yi=d, V=VCV, 
                     mod = ~ComparisonCategory -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint,  ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_ComparisonCategory1) # signif intc Benign-Worse only!   (ns intc Better-Benign / Better-Benign)
save(MR_all_ComparisonCategory1, file = "Rdata/MR_all_ComparisonCategory1.Rdata")

MR_all_ComparisonCategory <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$ComparisonCategory, ref="Benign-Worse"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_ComparisonCategory) # no signif diff Benign-Worse / Better-Benign / Better-Benign
save(MR_all_ComparisonCategory, file = "Rdata/MR_all_ComparisonCategory.Rdata")

MR_all_ComparisonCategory2 <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$ComparisonCategory, ref="Better-Benign"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_ComparisonCategory2) # no signif diff Benign-Worse / Better-Benign / Better-Benign
save(MR_all_ComparisonCategory2, file = "Rdata/MR_all_ComparisonCategory2.Rdata")

#max_absES

MR_all_ComparisonCategory1_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~ComparisonCategory -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_ComparisonCategory1_max_absES) # signif intc Benign-Worse only!   (ns intc Better-Benign / Better-Benign)
save(MR_all_ComparisonCategory1_max_absES, file = "Rdata/MR_all_ComparisonCategory1_max_absES.Rdata")

MR_all_ComparisonCategory_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$ComparisonCategory, ref="Benign-Worse"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_ComparisonCategory_max_absES) # no signif diff Benign-Worse / Better-Benign / Better-Benign
save(MR_all_ComparisonCategory_max_absES, file = "Rdata/MR_all_ComparisonCategory_max_absES.Rdata")

MR_all_ComparisonCategory2_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$ComparisonCategory, ref="Better-Benign"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_ComparisonCategory2_max_absES) # no signif diff Benign-Worse / Better-Benign / Better-Benign
save(MR_all_ComparisonCategory2_max_absES, file = "Rdata/MR_all_ComparisonCategory2_max_absES.Rdata")
```


- CueTypeCat
```{r MR all data - CueTypeCat}
MR_all_CueTypeCat1 <- rma.mv(yi=d, V=VCV, 
                     mod = ~CueTypeCat -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_CueTypeCat1) # signif intc for auditory only
save(MR_all_CueTypeCat1, file = "Rdata/MR_all_CueTypeCat1.Rdata")

MR_all_CueTypeCat <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$CueTypeCat, ref="auditory"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_CueTypeCat) # spatial and visual signif diff to auditory
save(MR_all_CueTypeCat, file = "Rdata/MR_all_CueTypeCat.Rdata")

MR_all_CueTypeCat2 <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$CueTypeCat, ref="olfactory"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint,  ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_CueTypeCat2) # no signif diff to olfactory
save(MR_all_CueTypeCat2, file = "Rdata/MR_all_CueTypeCat2.Rdata")

MR_all_CueTypeCat3 <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$CueTypeCat, ref="spatial"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_CueTypeCat3) # auditory signif diff to spatial
save(MR_all_CueTypeCat3, file = "Rdata/MR_all_CueTypeCat3.Rdata")

MR_all_CueTypeCat4 <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$CueTypeCat, ref="tactile"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_CueTypeCat4) # no signif diff to tactile
save(MR_all_CueTypeCat4, file = "Rdata/MR_all_CueTypeCat4.Rdata")

MR_all_CueTypeCat5 <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$CueTypeCat, ref="visual"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_CueTypeCat5) # auditory signif diff to visual
save(MR_all_CueTypeCat5, file = "Rdata/MR_all_CueTypeCat5.Rdata")

#max_absES

MR_all_CueTypeCat1_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~CueTypeCat -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint,  ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_CueTypeCat1_max_absES) # signif intc for auditory only
save(MR_all_CueTypeCat1_max_absES, file = "Rdata/MR_all_CueTypeCat1_max_absES.Rdata")

MR_all_CueTypeCat_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$CueTypeCat, ref="auditory"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint,  ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_CueTypeCat_max_absES) # spatial and visual signif diff to auditory
save(MR_all_CueTypeCat_max_absES, file = "Rdata/MR_all_CueTypeCat_max_absES.Rdata")

MR_all_CueTypeCat2_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$CueTypeCat, ref="olfactory"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_CueTypeCat2_max_absES) # no signif diff to olfactory
save(MR_all_CueTypeCat2_max_absES, file = "Rdata/MR_all_CueTypeCat2_max_absES.Rdata")

MR_all_CueTypeCat3_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$CueTypeCat, ref="spatial"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_CueTypeCat3_max_absES) # auditory signif diff to spatial
save(MR_all_CueTypeCat3_max_absES, file = "Rdata/MR_all_CueTypeCat3_max_absES.Rdata")

MR_all_CueTypeCat4_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$CueTypeCat, ref="tactile"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_CueTypeCat4_max_absES) # no signif diff to tactile
save(MR_all_CueTypeCat4_max_absES, file = "Rdata/MR_all_CueTypeCat4_max_absES.Rdata")

MR_all_CueTypeCat5_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$CueTypeCat, ref="visual"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_CueTypeCat5_max_absES) # no signif diff to visual
save(MR_all_CueTypeCat5_max_absES, file = "Rdata/MR_all_CueTypeCat5_max_absES.Rdata")
```


- FoodDeprived
```{r MR all data - FoodDeprived}
MR_all_FoodDeprived1 <- rma.mv(yi=d, V=VCV, 
                     mod = ~FoodDeprived -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_FoodDeprived1) # no signif intc yes / no
save(MR_all_FoodDeprived1, file = "Rdata/MR_all_FoodDeprived1.Rdata")

MR_all_FoodDeprived <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$FoodDeprived, ref="yes"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_FoodDeprived) # no signif diff yes / no
save(MR_all_FoodDeprived, file = "Rdata/MR_all_FoodDeprived.Rdata")

#max_absES

MR_all_FoodDeprived1_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~FoodDeprived -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_FoodDeprived1_max_absES) # no signif intc yes / no
save(MR_all_FoodDeprived1_max_absES, file = "Rdata/MR_all_FoodDeprived1_max_absES.Rdata")

MR_all_FoodDeprived_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$FoodDeprived, ref="yes"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_FoodDeprived_max_absES) # no signif diff yes / no
save(MR_all_FoodDeprived_max_absES, file = "Rdata/MR_all_FoodDeprived_max_absES.Rdata")
```


- TaskType
```{r MR all data - TaskType}
MR_all_TaskType1 <- rma.mv(yi=d, V=VCV, 
                     mod = ~TaskType -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_TaskType1) # signif intc active choice, but not go/no-go
save(MR_all_TaskType1, file = "Rdata/MR_all_TaskType1.Rdata")

MR_all_TaskType <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$TaskType, ref="active choice"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_TaskType) # no signif diff active choice vs. go/no-go
save(MR_all_TaskType, file = "Rdata/MR_all_TaskType.Rdata")

#max_absES

MR_all_TaskType1_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~TaskType -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_TaskType1_max_absES) # signif intc active choice, but not go/no-go
save(MR_all_TaskType1_max_absES, file = "Rdata/MR_all_TaskType1_max_absES.Rdata")

MR_all_TaskType_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$TaskType, ref="active choice"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_TaskType_max_absES) # no signif diff active choice vs. go/no-go
save(MR_all_TaskType_max_absES, file = "Rdata/MR_all_TaskType_max_absES.Rdata")
```


- WithinBetween
```{r MR all data - WithinBetween}
MR_all_WithinBetween1 <- rma.mv(yi=d, V=VCV, 
                     mod = ~WithinBetween -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_WithinBetween1) # signif intc within, not between
save(MR_all_WithinBetween1, file = "Rdata/MR_all_WithinBetween1.Rdata")

MR_all_WithinBetween <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$WithinBetween, ref="within"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_WithinBetween) # no signif diff within / between
save(MR_all_WithinBetween, file = "Rdata/MR_all_WithinBetween.Rdata")

#max_absES

MR_all_WithinBetween1_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~WithinBetween -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_WithinBetween1_max_absES) # signif intc within, not between
save(MR_all_WithinBetween1_max_absES, file = "Rdata/MR_all_WithinBetween1_max_absES.Rdata")

MR_all_WithinBetween_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$WithinBetween, ref="within"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint,  ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_WithinBetween_max_absES) # no signif diff within / between
save(MR_all_WithinBetween_max_absES, file = "Rdata/MR_all_WithinBetween_max_absES.Rdata")
```


- Automated
```{r MR all data - Automated}
MR_all_Automated1 <- rma.mv(yi=d, V=VCV, 
                     mod = ~Automated -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_Automated1) # no signif intc yes / no
save(MR_all_Automated1, file = "Rdata/MR_all_Automated1.Rdata")

MR_all_Automated <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$Automated, ref="yes"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint,  ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_Automated) # no signif diff yes / no
save(MR_all_Automated, file = "Rdata/MR_all_Automated.Rdata")

#max_absES

MR_all_Automated1_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~Automated -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_Automated1_max_absES) # no signif intc yes / no
save(MR_all_Automated1_max_absES, file = "Rdata/MR_all_Automated1_max_absES.Rdata")

MR_all_Automated_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$Automated, ref="yes"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_Automated_max_absES) # no signif diff yes / no
save(MR_all_Automated_max_absES, file = "Rdata/MR_all_Automated_max_absES.Rdata")
```


- Blind
```{r MR all data - Blind}
MR_all_Blind1 <- rma.mv(yi=d, V=VCV, 
                     mod = ~Blind -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_Blind1) # no signif intc yes / no
save(MR_all_Blind1, file = "Rdata/MR_all_Blind1.Rdata")

MR_all_Blind <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$Blind, ref="yes"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_Blind) # no signif diff yes / no
save(MR_all_Blind, file = "Rdata/MR_all_Blind.Rdata")

#max_absES

MR_all_Blind1_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~Blind -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_Blind1_max_absES) # no signif intc yes / no
save(MR_all_Blind1_max_absES, file = "Rdata/MR_all_Blind1_max_absES.Rdata")

MR_all_Blind_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$Blind, ref="yes"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_Blind_max_absES) # no signif diff yes / no
save(MR_all_Blind_max_absES, file = "Rdata/MR_all_Blind_max_absES.Rdata")
```



- ReinforcementCat
```{r MR all data - ReinforcementCat}
MR_all_ReinforcementCat1 <- rma.mv(yi=d, V=VCV, 
                     mod = ~ReinforcementCat -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_ReinforcementCat1) # signif intc R-P and R-R 
save(MR_all_ReinforcementCat1, file = "Rdata/MR_all_ReinforcementCat1.Rdata")

MR_all_ReinforcementCat <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$ReinforcementCat, ref="R-Null"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_ReinforcementCat) # signif diff R-Null vs  R-R
save(MR_all_ReinforcementCat, file = "Rdata/MR_all_ReinforcementCat.Rdata")

MR_all_ReinforcementCat2 <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$ReinforcementCat, ref="R-P"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_ReinforcementCat2) # no signif diff R-Null /  R-R / R-P
save(MR_all_ReinforcementCat2, file = "Rdata/MR_all_ReinforcementCat2.Rdata")

#max_absES

MR_all_ReinforcementCat1_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~ReinforcementCat -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_ReinforcementCat1_max_absES) # signif intc R-P and R-R 
save(MR_all_ReinforcementCat1_max_absES, file = "Rdata/MR_all_ReinforcementCat1_max_absES.Rdata")

MR_all_ReinforcementCat_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$ReinforcementCat, ref="R-Null"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_ReinforcementCat_max_absES) # signif diff R-Null vs  R-R
save(MR_all_ReinforcementCat_max_absES, file = "Rdata/MR_all_ReinforcementCat_max_absES.Rdata")

MR_all_ReinforcementCat2_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$ReinforcementCat, ref="R-P"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_ReinforcementCat2_max_absES) # no signif diff R-Null /  R-R / R-P
save(MR_all_ReinforcementCat2_max_absES, file = "Rdata/MR_all_ReinforcementCat2_max_absES.Rdata")
```


- AmbigReinforced
```{r MR all data - AmbigReinforced}
MR_all_AmbigReinforced1 <- rma.mv(yi=d, V=VCV, 
                     mod = ~AmbigReinforced -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_AmbigReinforced1) # no signif intc yes / no
save(MR_all_AmbigReinforced1, file = "Rdata/MR_all_AmbigReinforced1.Rdata")

MR_all_AmbigReinforced <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$AmbigReinforced, ref="yes"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_AmbigReinforced) # no signif diff yes / no
save(MR_all_AmbigReinforced, file = "Rdata/MR_all_AmbigReinforced.Rdata")

#max_absES

MR_all_AmbigReinforced1_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~AmbigReinforced -1, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_AmbigReinforced1_max_absES) #  signif intc no
save(MR_all_AmbigReinforced1_max_absES, file = "Rdata/MR_all_AmbigReinforced1_max_absES.Rdata")

MR_all_AmbigReinforced_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$AmbigReinforced, ref="yes"), 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_AmbigReinforced_max_absES) # no signif diff yes / no
save(MR_all_AmbigReinforced_max_absES, file = "Rdata/MR_all_AmbigReinforced_max_absES.Rdata")
```


- ScalePoint
```{r MR all data - ScalePoint}
ScalePoint_ord <- ordered(dat$ScalePoint, levels = c("P", "NP", "MID", "NN", "N"))

MR_all_ScalePoint1ord <- rma.mv(yi=d, V=VCV, 
                     mod = ~ScalePoint_ord -1, 
                     random=list(~1|Species_Latin, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_ScalePoint1ord) # no signif intc 
save(MR_all_ScalePoint1ord, file = "Rdata/MR_all_ScalePoint1ord.Rdata")

MR_all_ScalePoint1 <- rma.mv(yi=d, V=VCV, 
                     mod = ~ScalePoint -1, 
                     random=list(~1|Species_Latin, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_ScalePoint1) # no signif intc 
save(MR_all_ScalePoint1, file = "Rdata/MR_all_ScalePoint1.Rdata")

MR_all_ScalePoint_P <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$ScalePoint, ref="P"), 
                     random=list(~1|Species_Latin, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_ScalePoint_P) # no signif diff A / B / C
save(MR_all_ScalePoint_P, file = "Rdata/MR_all_ScalePoint_P.Rdata")

MR_all_ScalePoint_NP <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$ScalePoint, ref="NP"), 
                     random=list(~1|Species_Latin, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_ScalePoint_NP) # no signif diff
save(MR_all_ScalePoint_NP, file = "Rdata/MR_all_ScalePoint_NP.Rdata")

MR_all_ScalePoint_MID <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$ScalePoint, ref="MID"), 
                     random=list(~1|Species_Latin, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_ScalePoint_MID) # no signif diff 
save(MR_all_ScalePoint_MID, file = "Rdata/MR_all_ScalePoint_MID.Rdata")

MR_all_ScalePoint_NN <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$ScalePoint, ref="NN"), 
                     random=list(~1|Species_Latin, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_ScalePoint_NN) # no signif diff 
save(MR_all_ScalePoint_NN, file = "Rdata/MR_all_ScalePoint_NN.Rdata")

MR_all_ScalePoint_N <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$ScalePoint, ref="N"), 
                     random=list(~1|Species_Latin, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_ScalePoint_N) # no signif diff
save(MR_all_ScalePoint_N, file = "Rdata/MR_all_ScalePoint_N.Rdata")


#max_absES

MR_all_ScalePoint1_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~ScalePoint -1, 
                     random=list(~1|Species_Latin, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_ScalePoint1_max_absES) #  signif intc MID
save(MR_all_ScalePoint1_max_absES, file = "Rdata/MR_all_ScalePoint1_max_absES.Rdata")

MR_all_ScalePoint_max_absES_P <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$ScalePoint, ref="P"), 
                     random=list(~1|Species_Latin, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_ScalePoint_max_absES_P) # no signif diff 
save(MR_all_ScalePoint_max_absES_P, file = "Rdata/MR_all_ScalePoint_max_absES_P.Rdata")

MR_all_ScalePoint_max_absES_NP <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$ScalePoint, ref="NP"), 
                     random=list(~1|Species_Latin, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_ScalePoint_max_absES_NP) # no signif diff 
save(MR_all_ScalePoint_max_absES_NP, file = "Rdata/MR_all_ScalePoint_max_absES_NP.Rdata")

MR_all_ScalePoint_max_absES_MID <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$ScalePoint, ref="MID"), 
                     random=list(~1|Species_Latin, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_ScalePoint_max_absES_MID) # no signif diff 
save(MR_all_ScalePoint_max_absES_MID, file = "Rdata/MR_all_ScalePoint_max_absES_MID.Rdata")

MR_all_ScalePoint_max_absES_NN <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$ScalePoint, ref="NN"), 
                     random=list(~1|Species_Latin, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_ScalePoint_max_absES_NN) # no signif diff 
save(MR_all_ScalePoint_max_absES_NN, file = "Rdata/MR_all_ScalePoint_max_absES_NN.Rdata")

MR_all_ScalePoint_max_absES_N <- rma.mv(yi=d, V=VCV_max_absES, 
                     mod = ~relevel(dat_max_absES$ScalePoint, ref="N"), 
                     random=list(~1|Species_Latin, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_all_ScalePoint_max_absES_N) # no signif diff 
save(MR_all_ScalePoint_max_absES_N, file = "Rdata/MR_all_ScalePoint_max_absES_N.Rdata")
```



######################################################## VIF
###########################################################

#### Testing for multicollinearity among potential moderators VIF - all data

https://stats.stackexchange.com/questions/201205/variance-inflation-factors-vif-mer-verus-group-factor-level-vif

https://stackoverflow.com/questions/26633483/collinearity-after-accounting-for-random-mixed-effects

A VIF of 1 indicates there is no detectable linear relationship among the regressors, while a large VIF indicates a tight linear relationship.  A commonly used rule of thumb is that a VIF of 10 or more is evidence of severe multicollinearity (Cohen et )

```{r vif}
vif.mer <- function (fit) {
  ## adapted from rms::vif
  v <- vcov(fit)
  nam <- names(fixef(fit))
  ## exclude intercepts
  ns <- sum(1 * (nam == "Intercept" | nam == "(Intercept)"))
  if (ns > 0) {
    v <- v[-(1:ns), -(1:ns), drop = FALSE]
    nam <- nam[-(1:ns)] }
  d <- diag(v)^0.5
  v <- diag(solve(v/(d %o% d)))
  names(v) <- nam 
  v 
  }

library(lme4)
model <- lmer(d ~ MeasureType + TaskType + (1|ArticleID), data = dat)
vif.mer(model)

model <- lmer(d ~ Sex + Age + Captive_Wild.caught + AffectManipCat + AffectManipTiming + ComparisonCategory + CueTypeCat + FoodDeprived + TaskType + WithinBetween + Automated + Blind + MeasureType + ReinforcementCat + AmbigReinforced + ScalePoint + (1|ExperimentID), data = dat)
vif.mer(model) #no VIF >10, but TaskType has 8.8

model <- lmer(d ~ Sex + MeasureType + TaskType + CueTypeCat + FoodDeprived + ReinforcementCat + AmbigReinforced + WithinBetween + ScalePoint + (1|ExperimentID), data = dat)
vif.mer(model) #only TaskTypego/no-g and CueTypeCatspatial have VIF > 3

#as in our full model (simplified):
model <- lmer(d ~ Sex  + TaskType + CueTypeCat + ReinforcementCat + (1|ExperimentID), data = dat)
vif.mer(model) #all ok
```


################## FULL MODEL

- Full Model (all signif moderators, no interactions) 
```{r MR  data - full, all moderators }
#all data
MR_Full_0 <- rma.mv(yi=d, V=VCV, 
#                     mod = ~Sex + Age + Captive_Wild.caught + AffectManipCat + AffectManipTiming + ComparisonCategory + CueTypeCat + FoodDeprived + TaskType + WithinBetween + Automated + Blind  + ReinforcementCat + AmbigReinforced + ScalePoint, 
#                     mod = ~Sex + MeasureType + TaskType + CueTypeCat + FoodDeprived + ReinforcementCat + AmbigReinforced + WithinBetween, 
                     mod = ~Sex + TaskType + CueTypeCat + ReinforcementCat, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_Full_0) # all ns
R2(MR_Full_0) # all ns
save(MR_Full_0, file = "Rdata/MR_Full_0.Rdata")


#relevelling to biggest effect levels:
MR_Full_1 <- rma.mv(yi=d, V=VCV, 
                     mod = ~relevel(dat$Sex, ref="male") + relevel(dat$TaskType, ref="active choice") + relevel(dat$CueTypeCat, ref="visual") + relevel(dat$ReinforcementCat, ref="R-R"), 
                     random=list(~1|Species_Latin, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_Full_1) # all ns
save(MR_Full_1, file = "Rdata/MR_Full_1.Rdata")
```


################## Model selection #################

```{r all data -  model selection, eval=FALSE, include=FLASE}
# create a new function to run in MuMIn
#updated.rma.mv <- updateable(rma.mv)
#updated.rma.mv

eval(metafor:::.MuMIn)

# re-run full model with method = "ML" so that we can compare AIC (#does not converge with phylogeny)
mr_full <- rma.mv(yi=d, V=VCV, 
                     mod = ~Sex + TaskType + CueTypeCat + ReinforcementCat, 
                       test = "t",
                       random=list(~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                       method="ML",
                       data = dat)
summary(mr_full)
#R2(mr_full)
# testing call of new function
getCall(mr_full)
# update the new function to run in MuMIn
#update(mr_full)

# using dredge
meta_AICc <- dredge(mr_full, trace=2)
meta_AICc #does not work properly gives Warning: "Extra argument ('formula') disregarded
save(metaAICc, file = "Rdata/meta_AICc.Rdata")
#load(file = "Rdata/meta_AICc.Rdata")
par(mar = c(3,5,6,4))
plot(meta_AICc, labAsExpr = TRUE)
sub_meta_AICc <- subset(meta_AICc, delta < 2)
sub_meta_AICc

plot(sub_meta_AICc, labAsExpr = TRUE)
#write.table(sub_meta_AICc, "Rdata/AICc table .csv", sep = ",", row.names = F)

summary(model.avg(meta_AICc))
# importance of each predictor
importance(meta_AICc)
#Relative variable importance: 
#                      ReinforcementCat TaskType Sex  CueTypeCat
# Sum of weights:      0.49             0.46     0.35 0.23      
# N containing models:    8                8        8    8  
write.csv(importance(meta_AICc),'Rdata/importance_fullmodels.csv')

#'Best' model
summary(get.models(meta_AICc, 1)[[1]])
# Model Results:        estimate      se    tval    pval    ci.lb   ci.ub 
# intrcpt                0.0117  0.1042  0.1119  0.9109  -0.1931  0.2164    
# ReinforcementCatR-P    0.2084  0.1220  1.7081  0.0883  -0.0314  0.4481  . 
# ReinforcementCatR-R    0.4817  0.1956  2.4621  0.0142   0.0972  0.8662  * 
```

####################### Bayesian models #########################

```{r Bayesian full models, eval=FALSE, echo=FALSE, message=FALSE}

prior1 <- list( R=list(V=1,nu=.002), G=list(G1=list(V=1,nu=1, alpha.mu=0, alpha.V=1000), G2=list(V=1,nu=1, alpha.mu=0, alpha.V=1000), G3=list(V=1,nu=1, alpha.mu=0, alpha.V=1000), G4=list(V=1,nu=1, alpha.mu=0, alpha.V=1000), G5=list(V=1,fix=1))) #expanded parameter prior
ES <- dat$d
VES <- dat$Vd
invVC <- as(solve(VCV), "dgCMatrix")

#bayesian models (without phylogeny)
library(MCMCglmm)

set.seed(111)
bayesian_full1.1 <- MCMCglmm(ES ~ Sex + TaskType  + CueTypeCat + ReinforcementCat, random = ~ ScalePoint + ArticleID + ExperimentID + EffectID + idh(sqrt(Vd)):units, family="gaussian", ginverse = list(EffectID=invVC), data=dat, verbose=T, nitt=110000, thin=100, burnin=10000, pr=T, prior=prior1)

set.seed(112)
#bayesian_full1.2 <- MCMCglmm(ES ~ Sex + TaskType  + CueTypeCat + ReinforcementCat, random=~ArticleID+ExperimentID+EffectID, family="gaussian", ginverse = list(EffectID=invVC), data=dat, verbose=T, nitt=110000, thin=100, burnin=10000, pr=T, prior=prior1)

set.seed(113)
#bayesian_full1.3 <- MCMCglmm(ES ~ Sex + TaskType  + CueTypeCat + ReinforcementCat, random=~ArticleID+ExperimentID+EffectID, family="gaussian", ginverse = list(EffectID=invVC), data=dat, verbose=T, nitt=110000, thin=100, burnin=10000, pr=T, prior=prior1)

save(bayesian_full1.1,bayesian_full1.2, bayesian_full1.3,file="Rdata/bayesian_runs_full1.RData") 

summary(bayesian_full1.1) # DIC: 214.515 
#summary(bayesian_full1.2)
#summary(bayesian_full1.3)

#load("./Rdata/bayesian_runs_full1.Rdata") 
#Egger regr - following Vikki's code:
Prediction <- predict(bayesian_full1.1, marginal=~idh(sqrt(Vd)):units)
Precision <- sqrt(1/dat$Vd)
MR <- dat$d - Prediction 
zMR <- MR*Precision
plot(MR, Precision)

Egger <- lm(zMR ~ Precision)
summary(Egger) 
plot(MR, Precision, xlab = "Residuals", ylab="Precision (1/SE)",cex.lab=1.5, cex.axis=1.5)
abline(v=0,lty=3)
```

```{r Bayesian Egger's publication bias test, eval=FALSE, echo=FALSE, message=FALSE}

model <- bayesian_full1.1

Pred <- predict(model, marginal=~EffectID)
ES <- dat$d
VES <- dat$Vd
Prec <- 1/sqrt(VES) # Precision = 1/sqrt(V)
es <- ES-Pred
zes <- es*Prec
save(es,Prec,file="Rdata/residuals_Prec.RData")
set.seed(112)
Egger_bayesian_full <- MCMCglmm(zes~Prec,family="gaussian", data=data.frame(ES=es,Prec=Prec), verbose=TRUE, nitt=50000, thin=25, burnin=25000)
summary(Egger_bayesian_full) #no PB
plot(es, Prec, xlab="Egger regressed effect sizes", ylab=expression("Precision  "(1/sqrt(Variance))))
mean(zes)
mean(es)

round(summary(Egger_bayesian_full)$solutions[1,],3)

save(Egger_bayesian_full,file="Rdata/Egger_bayesian_full.RData")
#load(./Rdata/Egger_bayesian_full.RData")
```


###############################################################################################################
########################################         PUBLICATION BIAS       ####################################### 
###############################################################################################################


```{r funnel plot - full model, eval=FALSE, include=FALSE}
### PLOT - funnel plot
#pdf(file="Fig_funnel_alldata.pdf",width=6,height=4,pointsize=10)
par(mfcol=c(1,1)) 
par(mar=c(4,4,2,1))
#plot(dat$d, sqrt(1/dat$Vd), xlim=c(-8,8), xlab = "Effect size [Hd]", ylab="Precision [1/SE]", main="")
#abline(v=0,lty=3)

### full model - all data
funnel(MR_Full_0, yaxis = "seinv", level=c(90, 95, 99), shade=c("white", "gray55", "gray75"), refline=0, legend=TRUE)
#dev.off()


### full model - max_absES data
#funnel(MR_Full_0_max_absES, yaxis = "seinv", level=c(90, 95, 99), shade=c("white", "gray55", "gray75"), refline=0, legend=TRUE)
```


## Egger's test and calculating RESIDUALS for the final funnel plot

Checking the intercepts of Egger’s regressions performed on the model residuals and measurement errors.
Evidence for publication bias if the intercept is significantly different from 0.

Following Moreno et al. 2009 (BMC Medical Research Methodology) - Eggar regression can be reconfigured into a meta-regression model. However, following Nakagawa & Santos (2012), this meta-regression still assumes non-independence, so in our model we put SE into other model together with other significant moderators


## trim and fill ?

```{r publ bias tests trim and fill Egger, eval=FALSE, include=FALSE }
######## random-effect MA model:
res_MA <- rma.mv(yi=d, V=Vd, random=list(~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID), data=dat, method="REML") 
summary(res_MA) ### estimate  0.2239  CI  0.0913  0.3564  *** 

Residuals <- residuals(res_MA) # try MR_Full_0
Precision <- sqrt(1/res_MA$vi) #try MR_Full_0


PB_model <- rma(yi=Residuals, sei=1/Precision) 
summary(PB_model)
funnel(PB_model, yaxi="seinv")
# Trim and fill
TF <- trimfill(PB_model)
TF #Estimated number of missing studies on the left side: 51 (SE = 13.7423)
funnel(TF, yaxi="seinv")

# Egger's regression test
regtest(PB_model, model="lm") #test for funnel plot asymmetry: t = 0.5683, df = 457, p = 0.5701, for MR_Full_0 t = 0.1708, df = 457, p = 0.8645
ranktest(PB_model) #endall's tau = 0.0575 p = NA, for MR_Full_0 tau = 0.0299, p = NA
```

```{r funnel plot, eval=FALSE, include=FALSE}
# do not use:

#pdf(file="plots/Fig_funnels_prelim.pdf",width=7,height=3,pointsize=14)
par(mfrow=c(1,2))
par(mar=c(4,4,4,1))
plot(dat$d, sqrt(1/dat$Vd), xlim=c(-10,10), ylim=c(0,7), xlab = "effect size [Hd]", ylab="Precision [1/SE]", frame.plot=FALSE, main="A")
abline(v=0,lty=3)
abline(v=0.168,lty=1)
funnel(TF, xlim=c(-3,3), xlab = "effect size [Hd]", ylab="Standard Error [SE]",
       back="white", shade="lightgray", bg="red", main="B")
abline(v=0,lty=3)
plot(Residuals, Precision, xlim=c(-10,10), ylim=c(0,7), xlab = "Residuals", ylab="Precision [1/SE]", frame.plot=FALSE, main="C")
abline(v=0,lty=3)
#dev.off()
```



### Time-lag bias (univariate)

```{r time-lag bias, eval=FALSE, include=FLASE}
MR_all_Year <- rma.mv(yi=d, V=VCV, 
                     mod = ~Year, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat, method="REML") 
summary(MR_all_Year) # no signif slope
save(MR_all_Year, file = "./Rdata/MR_all_Year.Rdata")

# getting marginal R2
r2_MR_all_Year <- R2(MR_all_Year)

# getting estimates: name does not work for slopes
res_MR_all_Year <- get_est(MR_all_Year, mod = "Year")

# creating a table
# tibble(
#   `Fixed effect` = c("Intercept", "Year"),
#   Estimate = c(res_time_lag_effect_uni$estimate),
#   `Lower CI [0.025]` = c(res_time_lag_effect_uni$lowerCL),
#   `Upper CI  [0.975]` = c(res_time_lag_effect_uni$upperCL),
#   `V[authors]` = c(time_lag_effect_uni$sigma2, NA),
#   `R2` = c(r2_time_lag_effect_uni[1], NA)) %>% kable("html", digits = 3) %>%
#   kable_styling("striped", position = "left")

```


###############################################################################################################
######################################       SENSITIVITY ANALYSIS       ####################################### 
###############################################################################################################


###################################### Meta-analysis alternative robust models ################################

```{r robust model, eval=FALSE, include=FALSE}
#robust metafor
MA_all_robust <- robust(MA_all, cluster  =  dat$ExperimentID)
summary(MA_all_robust) #0.19922  0.0830  0.3014  *** 
save(MA_all_robust,file = "Rdata/MA_all_robust.Rdata")

#MA model - using a marix or vector to W which is equivalent to 'weights' in rma
#should bemore robust to publication bias (Henmi and Copas 2010)
robustml_MA <- rma.mv(yi = d, V = Vd, W = 1/dat$Vd, random = list(~1|ScalePoint, ~1|ArticleID, ~1|EffectID), method = "REML", data = dat)
summary(robustml_MA) #M 0.1778 0.0099  0.3457  *
save(robustml_MA,file = "Rdata/robustml_MA.Rdata")

#robumeta (without phylogeny and VCV)
MA_all_robu <- robu(formula = d ~ 1, var.eff.size = Vd, studynum = ExperimentID,  modelweights = "HIER", small = TRUE, data = dat)
print(MA_all_robu) #0.184   0.0835    0.285 ***
#save(MA_all_robu,file="Rdata/MA_all_robu.Rdata")
```

- Meta-regression - Full Model: meatafor + robust function
```{r MR all data - Full model robust metafor, eval=FALSE, include=FALSE}
MR_Full_0_robust <- robust(MR_Full_0, cluster  =  dat$ExperimentID)
summary(MR_Full_0_robust) #same pattern as in the original model - all na
save(MR_Full_0_robust,file = "Rdata/MR_Full_0_robust.Rdata")
```

- Bayesian models
```{r Bayesian all data, eval=FALSE, include=FALSE}
prior2 <- list( R=list(V=1, nu=.002), G=list(G1=list(V=1, nu=1, alpha.mu=0, alpha.V=1000), G2=list(V=1, nu=1, alpha.mu=0, alpha.V=1000), G3=list(V=1, fix=1))) #expanded parameter prior
ES <- dat$d
VES <- dat$Vd
invVC <- as(solve(VCV), "dgCMatrix")

#bayesian models (without phylogeny)

##meta-analysis
set.seed(111)
bayesian_MA1.1 <- MCMCglmm(ES ~ 1, random = ~ ScalePoint + ArticleID + ExperimentID, family="gaussian", ginverse = list(EffectID=invVC), data=dat, verbose=T, nitt=110000, thin=100, burnin=10000, pr=T, prior=prior2)
summary(bayesian_MA1.1)
save(bayesian_MA1.1, file = "Rdata/bayesian_MA1.1.Rdata")

#I2 for MA
s2 <- sum(1/dat$Vd*(length(1/dat$Vd)-1))/(sum(1/dat$Vd)^2-sum(1/dat$Vd^2)) 
I2 <- 100*(bayesian_MA1.1$VCV[,"ScalePoint"] + bayesian_MA1.1$VCV[,"ArticleID"] + bayesian_MA1.1$VCV[,"ExperimentID"]) / (bayesian_MA1.1$VCV[,"ScalePoint"] + bayesian_MA1.1$VCV[,"ArticleID"] + bayesian_MA1.1$VCV[,"ExperimentID"] + bayesian_MA1.1$VCV[,"units"] + s2)
posterior.mode(I2)
HPDinterval(I2)
#summary(I2)


##meta-regression
bayesian_MR1.1 <- MCMCglmm(ES ~ Sex + TaskType  + CueTypeCat + ReinforcementCat, random = ~ ScalePoint + ArticleID + ExperimentID, family="gaussian", ginverse = list(EffectID=invVC), data=dat, verbose=T, nitt=110000, thin=100, burnin=10000, pr=T, prior=prior2)
summary(bayesian_MR1.1)
save(bayesian_MR1.1, file = "Rdata/bayesian_MR1.1.Rdata")

#R2 for MR
(var(mean(bayesian_MR1.1$Sol[,2]) * bayesian_MR1.1$X[, 2] + mean(bayesian_MR1.1$Sol[, 3]) * bayesian_MR1.1$X[, 3] + mean(bayesian_MR1.1$Sol[ ,4]) * bayesian_MR1.1$X[, 4]) + sum(apply(bayesian_MR1.1$VCV,2,mean)[c(-3,-4)])) / (var(mean(bayesian_MR1.1$Sol[,2]) * bayesian_MR1.1$X[, 2] + mean(bayesian_MR1.1$Sol[, 3]) * bayesian_MR1.1$X[, 3] + mean(bayesian_MR1.1$Sol[ ,4]) * bayesian_MR1.1$X[, 4]) + sum(apply(bayesian_MR1.1$VCV,2,mean)[-3]))
```



###################################   SUBSET 1  - using ambiguous cues only  ################################## 

```{r ambiguos cues data subset, eval=FALSE, include=FALSE}
#dat_amb <- dplyr::filter(dat, ScalePoint %in% c("MID","NN","NP"))
dim(dat_amb) #269

#full model
MR_Full_0_ambES <- rma.mv(yi=d, V=VCV_dat_amb, 
#                     mod = ~Sex + Age + Captive_Wild.caught + AffectManipCat + AffectManipTiming + ComparisonCategory + CueTypeCat + FoodDeprived + TaskType + WithinBetween + Automated + Blind  + ReinforcementCat + AmbigReinforced + ScalePoint, 
                     mod = ~Sex + TaskType + CueTypeCat + ReinforcementCat, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_amb, method="REML") 
summary(MR_Full_0_ambES) #all ns
R2(MR_Full_0_ambES)
save(MR_Full_0_ambES, file = "Rdata/MR_Full_0_ambES.Rdata")
```


###################################   SUBSET 2  - using MID cue only  ################################## 

```{r MID_ES cues data subset, eval=FALSE, include=FALSE}
#dat_MID_ES <- dplyr::filter(dat, ScalePoint == "MID") #subset by picking only middle (MID) ES from each curve
dim(dat_MID_ES) #108

#full model
MR_Full_0_MID_ES <- rma.mv(yi=d, V=VCV_MID_ES, 
#                     mod = ~Sex + Age + Captive_Wild.caught + AffectManipCat + AffectManipTiming + ComparisonCategory + CueTypeCat + FoodDeprived + TaskType + WithinBetween + Automated + Blind  + ReinforcementCat + AmbigReinforced + ScalePoint, 
                     mod = ~Sex + TaskType + CueTypeCat + ReinforcementCat, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_MID_ES, method="REML") 
summary(MR_Full_0_MID_ES) #all ns
R2(MR_Full_0_MID_ES) 
save(MR_Full_0_MID_ES, file = "Rdata/MR_Full_0_MID_ES.Rdata")
```

###################################   SUBSET 3  - using max_absES  ################################## 

```{r max_abs_ES cues data subset, eval=FALSE, include=FALSE}
#dat_max_absES <- dplyr::filter(dat, biggest_ES == 1) #subset by picking ES with the biggest absolute value from each curve (i.e. get the most positive or negatve response available)
dim(dat_max_absES) #108

#full model
MR_Full_0_max_absES <- rma.mv(yi=d, V=VCV_max_absES, 
#                     mod = ~Sex + Age + Captive_Wild.caught + AffectManipCat + AffectManipTiming + ComparisonCategory + CueTypeCat + FoodDeprived + TaskType + WithinBetween + Automated + Blind  + ReinforcementCat + AmbigReinforced + ScalePoint, 
                     mod = ~Sex + TaskType + CueTypeCat + ReinforcementCat, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_absES, method="REML") 
summary(MR_Full_0_max_absES) #all ns
R2(MR_Full_0_max_absES)
save(MR_Full_0_max_absES, file = "Rdata/MR_Full_0_max_absES.Rdata")
```

###################################   SUBSET 4  - using max_meanES   ################################## 

```{r max_meanES cues data subset, eval=FALSE, include=FALSE}
#dat_max_meanES <- dplyr::filter(dat, biggest_meandir == 1) #subset by picking ES from each curve which has the biggest absolute value in the direction of the mean value of all ES from the curve (i.e. biggest in the overall direction of the response)
dim(dat_max_meanES) #108

#full model
MR_Full_0_max_meanES <- rma.mv(yi=d, V=VCV_max_meanES, 
#                     mod = ~Sex + Age + Captive_Wild.caught + AffectManipCat + AffectManipTiming + ComparisonCategory + CueTypeCat + FoodDeprived + TaskType + WithinBetween + Automated + Blind  + ReinforcementCat + AmbigReinforced + ScalePoint, 
                     mod = ~Sex + TaskType + CueTypeCat + ReinforcementCat, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_meanES, method="REML") 
summary(MR_Full_0_max_meanES) #all ns
R2(MR_Full_0_max_meanES)
save(MR_Full_0_max_meanES, file = "Rdata/MR_Full_0_max_meanES.Rdata")
```

###################################   SUBSET 5  - using max_ES   ################################## 

```{r max_ES cues data subset, eval=FALSE, include=FALSE}
#dat_max_ES <- dplyr::filter(dat, max_ES == 1) #subset by picking maximum ES from each curve (i.e. get the most positive=optimistic response available)
dim(dat_max_ES) #108

#full model
MR_Full_0_max_ES <- rma.mv(yi=d, V=VCV_max_ES, 
#                     mod = ~Sex + Age + Captive_Wild.caught + AffectManipCat + AffectManipTiming + ComparisonCategory + CueTypeCat + FoodDeprived + TaskType + WithinBetween + Automated + Blind  + ReinforcementCat + AmbigReinforced + ScalePoint, 
                     mod = ~Sex + TaskType + CueTypeCat + ReinforcementCat, 
                     random=list(~1|Species_Latin, ~1|ScalePoint, ~1|ArticleID, ~1|ExperimentID, ~1|EffectID),
                     R = list(Species_Latin = CorMatrix_all), 
                     data = dat_max_ES, method="REML") 
summary(MR_Full_0_max_ES) #olfactory-audio signif
R2(MR_Full_0_max_ES)
save(MR_Full_0_max_ES, file = "Rdata/MR_Full_0_max_ES.Rdata")
```
